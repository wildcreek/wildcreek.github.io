<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Docker部署WebRTC Server AppRTC实现手机、浏览器互通简易指南 | wildcreek</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Docker部署WebRTC Server AppRTC实现手机、浏览器互通简易指南</h1><a id="logo" href="/.">wildcreek</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Docker部署WebRTC Server AppRTC实现手机、浏览器互通简易指南</h1><div class="post-meta">Nov 27, 2017</div><div class="post-content"><h1 id="AppRTC是什么？"><a href="#AppRTC是什么？" class="headerlink" title="AppRTC是什么？"></a>AppRTC是什么？</h1><p>AppRTC是WebRTC源码中的Server Demo，具备Signaling Server、Room Server、TURN/STUN Server等相应功能。AppRTC作为服务端部分，可以实现Android 、iOS、浏览器等之间的视频通话。</p>
<p>源码：<a href="https://github.com/webrtc/apprtc" target="_blank" rel="external">https://github.com/webrtc/apprtc</a></p>
<p>官网 Demo：<a href="https://appr.tc/" target="_blank" rel="external">https://appr.tc/</a></p>
<h1 id="AppRTC怎么用？"><a href="#AppRTC怎么用？" class="headerlink" title="AppRTC怎么用？"></a>AppRTC怎么用？</h1><h2 id="使用官网Demo-Server"><a href="#使用官网Demo-Server" class="headerlink" title="使用官网Demo Server"></a>使用官网Demo Server</h2><p>略</p>
<h2 id="手动搭建部署"><a href="#手动搭建部署" class="headerlink" title="手动搭建部署"></a>手动搭建部署</h2><blockquote>
<p>源码是在Google app engine 的基础上部署的，由于Google Cloud服务不可用，这里使用了GAE SDK的方式部署。<br>由于网络和依赖等问题，这里不从零安装部署，使用了Piasy的Docker部署方案。</p>
</blockquote>
<h1 id="Docker常用命令"><a href="#Docker常用命令" class="headerlink" title="Docker常用命令"></a>Docker常用命令</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">列出所有容器（运行和停止的）docker ps -a</div><div class="line"></div><div class="line">停止容器                    </div><div class="line">docker stop &lt;container-id&gt;</div><div class="line"></div><div class="line">移除容器可读写层            </div><div class="line">docker rm &lt;container-id&gt;</div><div class="line"></div><div class="line">列出所有镜像                </div><div class="line">docker images -a</div><div class="line"></div><div class="line">删除镜像                    </div><div class="line">sudo docker rmi c1fe6d45bdad</div><div class="line"></div><div class="line">容器生成镜像              </div><div class="line">docker commit -m &quot;modify ice.js&quot; -a &quot;wildcreek&quot; 4ebdd4587ced </div><div class="line"></div><div class="line">加载镜像进容器，并运行镜像bash      </div><div class="line">docker run --rm --net=host -e PUBLIC_IP=x.x.x.x -v /root/docker/:/apprtc_configs -it  wildcreek/apprtc-server /bin/bash</div></pre></td></tr></table></figure>
<h1 id="Docker部署AppRTC简易指南"><a href="#Docker部署AppRTC简易指南" class="headerlink" title="Docker部署AppRTC简易指南"></a>Docker部署AppRTC简易指南</h1><blockquote>
<p>这里完全参考了<a href="https://blog.piasy.com/" target="_blank" rel="external">Piasy</a>的Docker<a href="https://blog.piasy.com/2017/06/17/out-of-the-box-webrtc-dev-env/" target="_blank" rel="external">部署方案</a>，并修改了几个小问题。piasy的demo目前测试支持android互通；此demo目前测试firefox57 和android手机互通正常，chrome 要求必须支持https （getUserMedia） 和wss，尚未改造完成暂不支持。</p>
</blockquote>
<h3 id="第一步：安装Docker"><a href="#第一步：安装Docker" class="headerlink" title="第一步：安装Docker"></a>第一步：安装Docker</h3><p>略</p>
<h3 id="第二步：拉取镜像"><a href="#第二步：拉取镜像" class="headerlink" title="第二步：拉取镜像"></a>第二步：拉取镜像</h3><p>docker pull wildcreek/apprtc-server</p>
<h3 id="第三步：修改配置"><a href="#第三步：修改配置" class="headerlink" title="第三步：修改配置"></a>第三步：修改配置</h3><p><a href="https://github.com/Piasy/WebRTC-Docker/blob/master/apprtc-server/constants.py" target="_blank" rel="external">https://github.com/Piasy/WebRTC-Docker/blob/master/apprtc-server/constants.py</a></p>
<h3 id="第四步：运行Server"><a href="#第四步：运行Server" class="headerlink" title="第四步：运行Server"></a>第四步：运行Server</h3><blockquote>
<p>docker run –rm –net=host -e PUBLIC_IP=x.x.x.x -v /root/docker/:/apprtc_configs -it  wildcreek/apprtc-server<br>./run.sh</p>
<h3 id="第五步：效果预览"><a href="#第五步：效果预览" class="headerlink" title="第五步：效果预览"></a>第五步：效果预览</h3><p> <img src="http://img.blog.csdn.net/20171127191453231?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveXVqaWh1OTg5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h1 id="修改Docker容器后重新提交的简单思路"><a href="#修改Docker容器后重新提交的简单思路" class="headerlink" title="修改Docker容器后重新提交的简单思路"></a>修改Docker容器后重新提交的简单思路</h1><p>见 <a href="https://github.com/Piasy/WebRTC-Docker/issues/3" target="_blank" rel="external">https://github.com/Piasy/WebRTC-Docker/issues/3</a> ，在此基础上修改，以此为例</p>
</blockquote>
<ol>
<li><p>修改 iceserver get方式获取</p>
<p>cd /apprtc/src/web_app/js</p>
<p>vim util.js   //将requestIceServers POST方法修改为GET </p>
</li>
<li><p>修复ice.js  CORS跨域访问问题</p>
<p> resp.header(“Access-Control-Allow-Origin”, “*”)</p>
<p> resp.header(“Access-Control-Allow-Credentials”,”true”)</p>
<p> resp.header(“Access-Control-Allow-Headers”, “Origin, X-Requested-With, Content-Type, Accept”)</p>
<p> resp.header(‘Access-Control-Allow-Methods’, ‘PUT, POST, GET, DELETE, OPTIONS’)</p>
</li>
<li><p>构建 ：cd /apprtc ; grunt build</p>
</li>
<li><p>部署appengine ：/usr/local/google_appengine/dev_appserver.py /apprtc/out/app_engine/</p>
</li>
<li><p>容器提交 docker commit -m “modify ice.js fix CORS” -a “wildcreek” 4ebdd4587ced wildcreek/apprtc-server</p>
</li>
<li><p>容器push: docker login ; docker push xxx/xxx</p>
</li>
<li><p>nginx https转发<br>7.1 nginx安装<br>apt-get update<br>apt-get install nginx<br>7.2 创建私钥和证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">首先，进入你想创建证书和私钥的目录，例如：</div><div class="line">cd /nginx</div><div class="line"></div><div class="line">创建服务器私钥，命令会让你输入一个口令：</div><div class="line">openssl genrsa -des3 -out server.key 1024</div><div class="line"></div><div class="line">创建签名请求的证书（CSR）：</div><div class="line">openssl req -new -key server.key -out server.csr</div><div class="line"></div><div class="line">在加载SSL支持的Nginx并使用上述私钥时除去必须的口令：</div><div class="line">cp server.key server.key.org</div><div class="line">openssl rsa -in server.key.org -out server.key</div><div class="line"></div><div class="line">最后标记证书使用上述私钥和CSR：</div><div class="line">openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt</div></pre></td></tr></table></figure>
</li>
</ol>
<p>7.3 nginx配置<br>sudo vim /etc/nginx/nginx.conf<br>//sudo vim /etc/nginx/sites-available/default  </p>
<p>server {<br>    listen 443;<br>    ssl on;<br>    server_name x.x.x.x;<br>    ssl_certificate /nginx/server.crt;<br>    ssl_certificate_key /nginx/server.key;<br>    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</p>
<pre><code>location / {
    # redirecting to http
    proxy_pass http://x.x.x.x:8080;
}
</code></pre><p>}</p>
<p>7.4 nginx 启动<br>service nginx -t<br>service nginx restart</p>
<p>7.5 容器提交 docker commit -m “nginx with https ,bug:need wss supprot” -a “wildcreek” 5e67a42e3fc6 wildcreek/apprtc-server</p>
<h1 id="问题清单"><a href="#问题清单" class="headerlink" title="问题清单"></a>问题清单</h1><p>已解决：</p>
<ol>
<li>js跨域访问 </li>
<li>https支持</li>
</ol>
<p>未解决：</p>
<ol>
<li>https需要配合wss使用，代码中为ws，提示：An insecure WebSocket connection may not be initiated from a page loaded over HTTPS</li>
</ol>
<p>参见：<a href="https://stackoverflow.com/questions/28625351/uncaught-securityerror-failed-to-construct-websocket-an-insecure-websocket-c#" target="_blank" rel="external">https://stackoverflow.com/questions/28625351/uncaught-securityerror-failed-to-construct-websocket-an-insecure-websocket-c#</a></p>
</div><div class="tags"></div><div class="post-nav"><a href="/2017/11/21/Intel WebRTC Collaboration Suite 服务端部署及客户端配置说明/" class="next">Intel WebRTC Collaboration Suite 服务端部署及客户端配置说明</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://wildcreek.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/27/Docker部署WebRTC Server AppRTC实现手机、浏览器互通简易指南/">Docker部署WebRTC Server AppRTC实现手机、浏览器互通简易指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/21/Intel WebRTC Collaboration Suite 服务端部署及客户端配置说明/">Intel WebRTC Collaboration Suite 服务端部署及客户端配置说明</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/12/Android开源SIP协议栈比较/">Android开源SIP协议栈比较</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/09/PJSIP2.7 Android版本编译及构建pjsua2和pjsua/">PJSIP2.7 Android版本编译及构建pjsua2和pjsua</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/09/Ubuntu14.0.4安装配置Kamailio5.0/">Ubuntu14.0.4安装配置Kamailio5.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/09/Kamailio glossary & misc(持续更新)/">Kamailio glossary & misc(持续更新)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/28/SIP proxy and SIP gateway/">SIP proxy and SIP gateway</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/18/Android Studio配置Gradle（包括signingConfigs、buildTypes和productFlavors等）/">Android Studio配置Gradle（包括signingConfigs、buildTypes和productFlavors等）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/17/Android实现基于试卷知识点的树形控件/">Android实现基于试卷知识点的树形控件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/17/Android实现选择题答题（包括单选、多选和答题卡）/">Android实现选择题答题（包括单选、多选和答题卡）</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">wildcreek.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>